name: integration-tests

on:
  push:
    paths:
      - '.github/workflows/integration-tests.yml'

jobs:
  generates:
    runs-on: ubuntu-latest
    outputs:
      RANDOM_PASSWORD: ${{ env.RANDOM_PASSWORD }}
    steps:
      - run: env | sort
      - run: echo "RANDOM_PASSWORD=$(LC_ALL=C tr -dc 'A-Za-z0-9' < /dev/urandom | head -c 12)" >> $GITHUB_ENV
      - run: echo "Generated RANDOM_PASSWORD=${{ env.RANDOM_PASSWORD }}"
      - run: env | sort

  testing:
    needs: generates
    runs-on: ubuntu-latest
    container:
      image: mysql:8.4
    services:
      mysqlserver:
        image: mysql:8.4
        env:
          MYSQL_ROOT_PASSWORD: ${{ needs.generates.outputs.RANDOM_PASSWORD }}
          MYSQL_DATABASE: foothebar
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    steps:
      - run: echo "Using RANDOM_PASSWORD=${{ needs.generates.outputs.RANDOM_PASSWORD }} for testing"
      - run: mysql --version
      - run: mysql -h mysqlserver -uroot -p${{ needs.generates.outputs.RANDOM_PASSWORD }} -e "SHOW DATABASES;"
      - run: echo "job.services= ${{ toJson(job.services) }}"
      - run: echo "github.container= ${{ toJson(job.container) }}"


    



